<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; text-align: center; }
        
        /* ログイン画面 */
        #login-screen { margin-top: 50px; }
        input[type="password"] { padding: 10px; font-size: 16px; width: 200px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        #error-msg { color: red; margin-top: 10px; }

        /* 写真一覧画面 */
        #gallery-screen { display: none; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .photo-card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #f9f9f9; }
        .photo-card img { width: 100%; height: auto; border-radius: 4px; object-fit: cover; aspect-ratio: 4/3; }
        .serial-number { font-weight: bold; margin: 5px 0; display: block; }
        .download-btn { display: inline-block; padding: 5px 10px; font-size: 14px; text-decoration: none; background: #28a745; color: white; border-radius: 4px; margin-top: 5px; }
        
        /* ローディング */
        #loading { display: none; margin-top: 20px; color: #666; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>パスワードを入力してください</h2>
        <input type="password" id="password-input" placeholder="Password">
        <button onclick="handleLogin()">送信</button>
        <div id="error-msg"></div>
        <div id="loading">確認中...</div>
    </div>

    <div id="gallery-screen">
        <h2>写真一覧</h2>
        <div class="gallery-grid" id="photo-container">
            </div>
    </div>

    <script>
        // 【重要】ここにGASのウェブアプリURLを貼り付けてください
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzVfaEy_BAO_dNSFXQBgLOM6lBMGaKnX18F4DRrE1g5AsAnvHsPyZ2qSHRTrkxyjHre/exec";

        function handleLogin() {
            const password = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('error-msg');
            const loading = document.getElementById('loading');
            
            errorMsg.innerText = "";
            loading.style.display = "block";

            // GASへPOST送信
            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "login", password: password })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = "none";
                if (data.status === 'success') {
                    showGallery(data.data);
                } else if (data.status === 'auth_failed') {
                    errorMsg.innerText = "パスワードが間違っています。";
                } else {
                    errorMsg.innerText = "エラーが発生しました: " + data.message;
                }
            })
            .catch(error => {
                loading.style.display = "none";
                errorMsg.innerText = "通信エラーが発生しました。";
                console.error(error);
            });
        }

function showGallery(photoList) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('gallery-screen').style.display = 'block';
            
            const container = document.getElementById('photo-container');
            container.innerHTML = ""; // クリア

            photoList.forEach(photo => {
                const card = document.createElement('div');
                card.className = 'photo-card';

                // 初期状態は「読み込み中...」と表示し、IDを付与しておく
                const imgId = `img-${photo.fileId}`;
                const linkId = `link-${photo.fileId}`;

                card.innerHTML = `
                    <div style="height:200px; display:flex; align-items:center; justify-content:center; background:#eee;" id="placeholder-${photo.fileId}">
                        読み込み中...
                    </div>
                    <img id="${imgId}" style="display:none;" alt="${photo.filename}">
                    <span class="serial-number">No. ${photo.id}</span>
                    <a id="${linkId}" href="#" class="download-btn" style="display:none;">ダウンロード</a>
                `;
                
                container.appendChild(card);

                // 画像データを個別に取得しに行く
                loadImage(photo.fileId, imgId, linkId, `placeholder-${photo.fileId}`);
            });
        }

        function loadImage(fileId, imgId, linkId, placeholderId) {
            // GETリクエストでBase64データを取得
            fetch(`${GAS_URL}?fileId=${fileId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const img = document.getElementById(imgId);
                    const link = document.getElementById(linkId);
                    const placeholder = document.getElementById(placeholderId);
                    
                    // Base64を画像ソースとしてセット
                    const dataUrl = `data:${data.mime};base64,${data.data}`;
                    
                    img.src = dataUrl;
                    img.style.display = 'block'; // 画像を表示
                    placeholder.style.display = 'none'; // ローディングを消す

                    // ダウンロードリンクの設定
                    link.href = dataUrl;
                    link.download = data.filename;
                    link.style.display = 'inline-block';
                }
            })
            .catch(err => console.error("Image load error:", err));
        }    </script>
</body>
</html>
