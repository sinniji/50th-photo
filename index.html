const GAS_URL = "https://script.google.com/macros/s/AKfycbzVfaEy_BAO_dNSFXQBgLOM6lBMGaKnX18F4DRrE1g5AsAnvHsPyZ2qSHRTrkxyjHre/exec"; 

let selectedPhotoIds = [];

function handleLogin() {
    const password = document.getElementById('password-input').value;
    const errorMsg = document.getElementById('error-msg');
    const loading = document.getElementById('loading');
    
    errorMsg.innerText = "";
    loading.style.display = "block";

    fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({ action: "login", password: password })
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = "none";
        if (data.status === 'success') {
            showGallery(data.data);
        } else if (data.status === 'auth_failed') {
            errorMsg.innerText = "パスワードが間違っています。";
        } else {
            errorMsg.innerText = "エラー: " + data.message;
        }
    })
    .catch(error => {
        loading.style.display = "none";
        errorMsg.innerText = "通信エラーが発生しました。";
        console.error(error);
    });
}

function showGallery(photoList) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('gallery-screen').style.display = 'block';
    
    const container = document.getElementById('photo-container');
    container.innerHTML = "";

    photoList.forEach(photo => {
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.id = `card-${photo.id}`;

        const imgId = `img-${photo.fileId}`;
        const placeholderId = `place-${photo.fileId}`;
        const linkId = `dl-${photo.fileId}`;

        card.innerHTML = `
            <div class="img-area" onclick="toggleSelection('${photo.id}')">
                <div class="check-mark">✔</div>
                
                <div id="${placeholderId}" style="height:160px; display:flex; align-items:center; justify-content:center; background:#eee; color:#999;">
                    <span style="font-size:12px;">読込中...</span>
                </div>
                
                <img id="${imgId}" style="display:none; width:100%; aspect-ratio:4/3; object-fit:cover; border-radius:4px;" alt="${photo.filename}">
            </div>
            
            <span class="serial-number">No. ${photo.id}</span>
            
            <a id="${linkId}" href="#" class="download-btn disabled">準備中...</a>
        `;
        
        container.appendChild(card);

        // サムネイル画像をロード
        loadThumbnail(photo.fileId, imgId, placeholderId, linkId, photo.filename);
    });
}

// サムネイル画像をロード
function loadThumbnail(fileId, imgId, placeholderId, linkId, filename) {
    fetch(`${GAS_URL}?fileId=${fileId}&type=thumbnail`)
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const img = document.getElementById(imgId);
            const placeholder = document.getElementById(placeholderId);
            
            img.src = `data:image/jpeg;base64,${data.data}`;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            
            // ダウンロードボタンを準備
            setupDownloadButton(fileId, linkId, filename);
        }
    })
    .catch(err => {
        console.error(err);
        document.getElementById(placeholderId).innerText = "読込失敗";
    });
}

// ダウンロードボタンの設定
function setupDownloadButton(fileId, linkId, filename) {
    const link = document.getElementById(linkId);
    link.classList.remove('disabled');
    link.innerText = 'ダウンロード';
    
    link.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation(); // 親要素のクリックイベント防止
        
        link.innerText = '準備中...';
        link.classList.add('disabled');
        
        fetch(`${GAS_URL}?fileId=${fileId}&type=download`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const dataUrl = `data:${data.mime};base64,${data.data}`;
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = filename;
                a.click();
                
                link.innerText = 'ダウンロード';
                link.classList.remove('disabled');
            }
        })
        .catch(err => {
            console.error(err);
            alert('ダウンロードに失敗しました');
            link.innerText = 'ダウンロード';
            link.classList.remove('disabled');
        });
    };
}

function toggleSelection(id) {
    const card = document.getElementById(`card-${id}`);
    const idStr = String(id);

    if (selectedPhotoIds.includes(idStr)) {
        selectedPhotoIds = selectedPhotoIds.filter(item => item !== idStr);
        card.classList.remove('selected');
    } else {
        selectedPhotoIds.push(idStr);
        card.classList.add('selected');
    }
    
    document.getElementById('selected-count').innerText = selectedPhotoIds.length;
}

function submitOrder() {
    const branch = document.getElementById('branch-input').value;
    const name = document.getElementById('name-input').value;
    const msgDiv = document.getElementById('order-msg');

    msgDiv.innerText = "";

    if (selectedPhotoIds.length === 0) {
        alert("写真が1枚も選択されていません。\n画像をクリックして選択してください（青枠がつきます）。");
        return;
    }
    if (!branch || !name) {
        alert("「支部名」と「お名前」を入力してください。");
        return;
    }

    if (!confirm(`【確認】\n\n支部名: ${branch}\n氏名: ${name}\n\n写真 ${selectedPhotoIds.length} 枚を注文しますか？`)) {
        return;
    }

    msgDiv.innerText = "送信中...";
    msgDiv.style.color = "black";

    fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({
            action: "order",
            branch: branch,
            name: name,
            selectedPhotos: selectedPhotoIds
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            msgDiv.innerText = "送信完了しました！";
            msgDiv.style.color = "green";
            alert("ご注文ありがとうございます。\n申し込みを受け付けました。");
            
            selectedPhotoIds = [];
            document.querySelectorAll('.photo-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('selected-count').innerText = "0";
            document.getElementById('name-input').value = "";
        } else {
            msgDiv.innerText = "サーバーエラー: " + data.message;
            msgDiv.style.color = "red";
        }
    })
    .catch(err => {
        msgDiv.innerText = "通信エラーが発生しました";
        msgDiv.style.color = "red";
    });
}
